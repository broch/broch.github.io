<!doctype html><html lang=en><head><title>Trying out Rust's Async Functions in Traits</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Exploring the latest Rust nightly features for using async functions in traits"><link href="/css/main.min.cbea4dffd5bf7bf2c87de9504c4cac811c1f22ad854c538f0e08bbad25d60973.css" rel=stylesheet><link rel=icon type=image/svg+xml href=/images/logo.svg><link rel=stylesheet href=https://rsms.me/inter/inter.css><script src=/js/prism.js></script></head><body class="bg-stone-50 text-stone-600 dark:bg-stone-900 dark:text-stone-400"><nav class="mb-1 shadow dark:shadow-none dark:border-b dark:border-stone-300/10"><div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8"><div class="relative flex justify-between h-20"><div class="absolute inset-y-0 left-0 flex items-center sm:hidden"><button id=menu-button type=button class="inline-flex items-center justify-center p-2 rounded-md text-stone-400 hover:text-stone-500 hover:bg-stone-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-red-600" aria-controls=mobile-menu aria-expanded=false>
<span class=sr-only>Open main menu</span><svg id="open-menu-icon" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg><svg id="close-menu-icon" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/></svg></button></div><div class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start"><div class="flex-shrink-0 flex items-center"><a href=/><svg class="block lg:hidden h-14 w-auto dark:fill-stone-300 dark:stroke-stone-400" viewBox="0 0 1250 1250"><desc>Broch logo</desc><path d="M50 550A5e2 5e2.0 01550 50h145a5e2 5e2.0 015e2 5e2v1e2a5e2 5e2.0 01-5e2 5e2v-130a370 370 0 00370-370m0-1e2A370 370 0 00695 180H550A370 370 0 00180 550m0 1e2a370 370 0 00370 370v130A5e2 5e2.0 0150 650V550" stroke-width="55" fill="none"/></svg><svg class="hidden lg:block h-14 w-auto dark:fill-stone-300 dark:stroke-stone-400" stroke="#292524" fill="#292524" viewBox="0 0 3500 1250"><desc>Broch logo</desc><g><path d="M50 550A5e2 5e2.0 01550 50h145a5e2 5e2.0 015e2 5e2v1e2a5e2 5e2.0 01-5e2 5e2v-130a370 370 0 00370-370m0-1e2A370 370 0 00695 180H550A370 370 0 00180 550m0 1e2a370 370 0 00370 370v130A5e2 5e2.0 0150 650V550" stroke-width="55" fill="none"/></g><g transform="translate(1600 1050) scale(.18 -.18)"><path d="m525 3939c-137-15-256-28-263-28-10-1-12-289-10-1423l3-1423 267-3 267-2 5 32c3 18 10 60 16 92 5 33 10 62 10 64 0 3 33-26 73-64 85-82 137-114 243-151 71-24 93-27 214-27 98-1 153 4 2e2 17 258 69 463 295 555 613 40 137 55 260 55 456 0 417-89 7e2-279 888-128 127-269 181-471 182-201 0-342-54-472-183l-78-76v533 534l-42-1c-24-1-155-14-293-30zm811-1247c56-29 119-103 144-169 34-92 51-230 51-427 0-99-5-213-11-251-31-198-95-316-204-373-44-22-63-26-136-26-122 0-203 40-281 137l-39 50v427 428l43 59c63 84 130 136 217 164 46 15 171 4 216-19z"/><path d="m8303 3942-253-25V2493 1070h3e2 3e2v698 697l51 67c96 128 197 192 303 192 70-1 115-20 144-61 47-69 46-54 50-845l3-748h299 3e2v803c0 891 0 881-66 1016-108 219-359 323-642 265-141-29-251-87-366-195l-76-71v541 541l-47-1c-27-1-162-13-3e2-27z"/><path d="m4655 3155c-268-42-482-178-629-399-234-353-231-1006 7-1356 123-181 310-311 521-360 182-44 421-44 591 0 1e2 25 241 93 322 154 302 228 436 668 356 1166-60 379-286 657-618 759-155 48-380 63-550 36zm306-445c82-23 161-105 2e2-209 65-175 77-537 23-744-35-138-99-228-192-274-50-24-68-28-147-28-105 0-163 23-226 88-99 102-148 320-136 612 7 171 27 277 72 372 78 167 225 234 406 183z"/><path d="m6898 3155c-402-68-686-357-779-795-29-136-32-406-6-547 87-473 408-765 884-803 134-10 285 3 399 35 156 44 393 176 380 211-4 10-223 326-250 361-1 1-51-22-111-52-79-39-135-59-198-71-81-16-93-16-169-1-236 46-330 240-315 642 9 231 49 363 140 462 136 147 391 144 613-7l40-28 128 175c72 1e2 125 182 122 190-9 23-187 132-269 164-195 75-410 97-609 64z"/><path d="m3498 3137c-153-53-279-181-354-364-13-32-24-53-24-48-1 6-11 91-23 190l-22 180-267 3-268 2V2085 1070h305 304l3 533 3 532 33 95c98 283 233 378 480 337 60-10 85-11 88-3 7 20 94 569 91 573-10 10-121 23-196 23-63 0-104-7-153-23z"/></g></svg></a></div><div class="hidden sm:ml-9 sm:flex sm:space-x-8"><a class="border-transparent text-stone-400 hover:border-stone-300 hover:text-stone-700 dark:hover:text-stone-400 inline-flex items-center px-1 pt-1 border-b-2 text-lg font-medium" href=/ title>Home</a>
<a class="border-red-600 dark:border-red-500 text-stone-900 dark:text-stone-300 inline-flex items-center px-1 pt-1 border-b-2 text-lg font-medium" href=/posts/ title=Blog>Blog</a></div></div><div class="absolute inset-y-0 right-0 flex items-center pr-2 sm:static sm:inset-auto sm:ml-6 sm:pr-0"><a href=/index.xml class="p-1 rounded-full text-stone-400 hover:text-stone-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><span class=sr-only>RSS Feed</span><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18.0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"/></svg></a></div></div></div><div class=hidden id=mobile-menu><div class="pt-2 pb-4 space-y-1"><a class="border-transparent text-stone-500 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-400 hover:border-stone-300 hover:text-stone-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium" href=/ title>Home</a>
<a class="bg-red-50 dark:bg-red-800 border-red-600 text-red-900 dark:text-red-300 block pl-3 pr-4 py-2 border-l-4 text-base font-medium" href=/posts/ title=Blog>Blog</a></div></div></nav><script>var menu_open=!1,menu_button=document.getElementById("menu-button"),menu=document.getElementById("mobile-menu"),open_icon=document.getElementById("open-menu-icon"),close_icon=document.getElementById("close-menu-icon");menu_button.addEventListener("click",function(){menu_open=!menu_open,menu_open?(menu.className="block sm:hidden",close_icon.className.baseVal="block h-6 w-6",open_icon.className.baseVal="hidden h-6 w-6"):(menu.className="hidden",open_icon.className.baseVal="block h-6 w-6",close_icon.className.baseVal="hidden h-6 w-6")})</script><div class="w-full max-w-7xl mx-auto"><main><article class="py-12 px-4 sm:px-8 lg:px-8 prose prose-stone prose-lg max-w-none lg:prose-xl dark:prose-invert"><h1>Trying out Rust's Async Functions in Traits</h1><p class="block flex display-between text-stone-500 dark:text-stone-400 italic">August 31, 2023</p><p>Async functions in traits have been available in Rust nightly releases for some time now behind the feature gate <code>async_fn_in_trait</code>. The current status is summarized in the <a href=https://blog.rust-lang.org/inside-rust/2023/05/03/stabilizing-async-fn-in-trait.html>Inside Rust blog</a>. Many of the issues are also explained in more detail by Niko Matsakis in his <a href=https://smallcultfollowing.com/babysteps/>Baby Steps blog</a>.</p><p>I decided to try the feature out with some existing code which was using the <a href=https://crates.io/crates/async-trait><code>async-trait</code></a> library (which provides a workaround for stable Rust).</p><p>Working code for the example in this article can be found <a href=https://github.com/tekul/rust-async-fn-trait>on Github</a>.</p><h2 id=existing-code-using-async-trait-and-actix>Existing code using <code>async-trait</code> and actix</h2><p>The code I have is quite complicated but the idea can be reduced to a <code>Database</code> trait which is used by an actix web handler. There&rsquo;s also an axum version of the application but we&rsquo;ll get to that later. A toy example which models this could be written as follows:</p><pre><code class=language-rust>use async_trait::async_trait;

pub struct Data {
    id: String,
}

#[async_trait]
pub trait Database {
    async fn load_data(&amp;self, id: &amp;str) -&gt; Data;
}

struct SillyDatabase {};

#[async_trait]
impl Database for SillyDatabase {
    async fn load_data(&amp;self, &amp;str id) -&gt; Data {
        Data { id: id.to_string() }
    }
}

</code></pre><p>The actix application has a function to setup the routes which is generic in the <code>Database</code> type, allowing it to be run with different backend implementations:</p><pre><code class=language-rust>use actix_web::{
    web::{self, ServiceConfig},
    App, HttpRequest, HttpResponse, HttpServer,
};

pub fn mk_app&lt;B&gt;(backend: B) -&gt; impl FnOnce(&amp;mut ServiceConfig)
where
    B: Database + 'static,
{
    move |app| {
        app.app_data(backend).service(web::resource(&quot;/data&quot;).to(get_data::&lt;B&gt;));
    }
}

async fn get_data&lt;B&gt;(req: HttpRequest) -&gt; HttpResponse
where
    B: Database + 'static
{
    let backend = req
        .app_data::&lt;B&gt;()
        .expect(&quot;app_data should include Database&quot;);
    let Data { id } = backend.load_data(&quot;some_id&quot;).await;
    HttpResponse::Ok().body(format!(&quot;Loaded data, with id {id}&quot;))
}

#[tokio::main]
async fn main() -&gt; io::Result&lt;()&gt; {
    let database = SillyDatabase {};
    let server = HttpServer::new(move || {
        App::new().configure(mk_app(database.clone()))
    })
    .bind(&quot;127.0.0.1:8088&quot;)
    .unwrap();
    server.run().await
}

</code></pre><p>Running the app with <code>cargo run</code> and then sending a GET request to the URL works as expected:</p><pre><code class=language-shell>$ curl localhost:8088/data
Loaded data, with id 'some_id'
</code></pre><h3 id=without-async-trait>Without <code>async-trait</code></h3><p>Ideally we can just switch to nightly rust, enable the feature, remove the <code>async_trait</code> macros and it will just work:</p><pre><code class=language-rust>#![feature(async_fn_in_trait)]

trait Database {
    async fn load_data(&amp;self, &amp;str id) -&gt; Data;
}

impl Database for SillyDatabase {
   // Same as before...
}
</code></pre><p>And indeed it does! We can just run the app as before and we get the same result. Well that was easy. Looks like we can just go ahead and forget about the <code>async-trait</code> crate already?</p><h2 id=adding-an-axum-version>Adding an axum version</h2><p>Not so fast. Let&rsquo;s try doing the same thing with axum. The equivalent code for the server is</p><pre><code class=language-rust>use std::net::SocketAddr;

use async_trait::async_trait;
use axum::{extract::State, response::IntoResponse, routing::get, Router};

pub fn mk_app&lt;B&gt;(backend: B) -&gt; Router
where
    B: Clone + Send + Sync + Database + 'static,
{
    Router::new()
        .route(&quot;/data&quot;, get(get_data::&lt;B&gt;))
        .with_state(backend)
}

async fn get_data&lt;B&gt;(State(backend): State&lt;B&gt;) -&gt; impl IntoResponse
where
    B: Database,
{
    let Data { id } = backend.load_data(&quot;some_id&quot;).await;
    format!(&quot;Loaded data, with id {id}&quot;)
}

#[tokio::main]
async fn main() {
    let backend = SillyDatabase {};
    let addr = SocketAddr::from(([0, 0, 0, 0, 0, 0, 0, 0], 8088));
    axum_server::bind(addr)
        .serve(mk_app(backend).into_make_service())
        .await
        .expect(&quot;server error&quot;);
}

</code></pre><p>This also works with the <code>async-trait</code> version of our <code>Database</code> trait. But what happens if we switch to using <code>async_fn_in_trait</code> again:</p><pre><code>error[E0277]: the trait bound `fn(State&lt;B&gt;) -&gt; impl Future&lt;Output = impl IntoResponse&gt; {get_data::&lt;B&gt;}: Handler&lt;_, _, _&gt;` is not satisfied
   --&gt; src/bin/axum.rs:28:29
    |
28  |         .route(&quot;/data&quot;, get(get_data::&lt;B&gt;))
    |                         --- ^^^^^^^^^^^^^ the trait `Handler&lt;_, _, _&gt;` is not implemented for fn item `fn(State&lt;B&gt;) -&gt; impl Future&lt;Output = impl IntoResponse&gt; {get_data::&lt;B&gt;}`
    |                         |
    |                         required by a bound introduced by this call
    |
    = note: Consider using `#[axum::debug_handler]` to improve the error message
    = help: the following other types implement trait `Handler&lt;T, S, B&gt;`:
              &lt;Layered&lt;L, H, T, S, B, B2&gt; as Handler&lt;T, S, B2&gt;&gt;
              &lt;MethodRouter&lt;S, B&gt; as Handler&lt;(), S, B&gt;&gt;
note: required by a bound in `axum::routing::get`
</code></pre><p>Oops, it doesn&rsquo;t work! This opaque error message is common with axum and means that our function needs to implement <code>Handler</code> but doesn&rsquo;t. Axum defines Handler implementations for lots of things and we don&rsquo;t usually have to worry about it, but for some reason our function no longer satisfies the requirements even though it did before and we haven&rsquo;t changed the function directly. If we try to follow the advice to use the <code>axum::debug_handler</code> macro we will get an additional error message:</p><pre><code>error: `#[axum_macros::debug_handler]` doesn't support generic functions
  --&gt; src/bin/axum.rs:33:18
   |
33 | async fn get_data&lt;B&gt;(State(backend): State&lt;B&gt;) -&gt; impl IntoResponse
   |                  ^^^
</code></pre><p>So that is no help either. If we remove the generic handler and just use <code>SillyDatabase</code> directly, the problem goes away. But that&rsquo;s not what we want. The real code is written to be generic because the router it creates is part of a library and using a trait means users can configure it with whatever backend they want. So why isn&rsquo;t it working any more?</p><h2 id=the-send-bound-problem>The <code>Send</code> bound problem</h2><p>Fortunately I&rsquo;d been reading the blogs I mentioned at the start of this post and the related issues in github and there&rsquo;s a lot of discussion about how to make the futures returned by the <code>async</code> functions in traits implement <code>Send</code> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. This is a common requirement when using Tokio&rsquo;s multi-threaded runtime which can move tasks about between threads, and this is why it is also a requirement for Axum. In fact, if we look at the section called <a href=https://docs.rs/axum/0.6.20/axum/handler/index.html#debugging-handler-type-errors>Debugging handler type errors</a> the last point is that a handler function must:</p><blockquote><p>Return a future that is Send. The most common way to accidentally make a future !Send is to hold a !Send type across an await.</p></blockquote><p>When we used <code>async-trait</code>, it automatically adds the <code>Send</code> bound to the function in both the trait and the implementation by default. So the <code>Database</code> trait&rsquo;s <code>load_data</code> function is guaranteed to return a future that is <code>Send</code>. We can check this by changing the <code>async_trait macro</code> usage to <code>#[async_trait(?Send)]</code> which no longer adds the <code>Send</code> bound. This gives us the same <code>Handler</code> error that we see above.</p><p>When we switch to using <code>async_fn_in_trait</code> it is no longer the default to assume that the returned future must be <code>Send</code>. In our code the <code>get_data</code> handler is awaiting a future returned by the <code>load_data</code> method and thus we get the error since the future is not guaranteed to be <code>Send</code>.</p><h3 id=using-the-return_type_notation-feature>Using the <code>return_type_notation</code> feature</h3><p>So is there a way for our <code>get_data</code> handler to say that it only supports <code>Database</code> implementations which return a <code>Send</code> future? It turns out there is if we use the bleeding edge <code>return_type_notation</code> feature <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. If we add the feature then change our <code>mk_app</code> function to use it:</p><pre><code class=language-rust>#![feature(async_fn_in_trait, return_type_notation)]
...

pub fn mk_app&lt;B&gt;(backend: B) -&gt; Router
where
    B: Clone + Send + Sync + Database&lt;load_data(): Send&gt; + 'static,
{
    ...
}
</code></pre><p>this should fix the problem. Unfortunately we then get another error (ignoring a warning about using incomplete features):</p><pre><code>error[E0277]: `impl Future&lt;Output = Data&gt;` cannot be sent between threads safely
  --&gt; src/bin/axum.rs:46:23
   |
46 |         .serve(mk_app(backend).into_make_service())
   |                ------ ^^^^^^^ `impl Future&lt;Output = Data&gt;` cannot be sent between threads safely
   |                |
   |                required by a bound introduced by this call
</code></pre><p>This is still complaining that our future is <code>!Send</code> even though the compiler knows that <code>backend</code> is a <code>SillyDatabase</code> at this point, which should be fine. Fortunately someone else had already run into the same problem <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. If we use &ldquo;turbofish&rdquo; syntax to explicitly tell <code>mk_app</code> what type we&rsquo;re using:</p><pre><code class=language-rust>    axum_server::bind(addr)
        .serve(mk_app::&lt;SillyDatabase&gt;(backend).into_make_service())
        .await
        .expect(&quot;server error&quot;);

</code></pre><p>Then our code finally compiles.</p><h3 id=what-about-actix>What about Actix?</h3><p>Actix works without any issues though which is a bit confusing since it uses the same <code>#[tokio::main]</code> macro. In the past Actix had its own runtime implementation, which used multiple single-threaded Tokio runtimes and did not need futures to be <code>Send</code>. Under the hood, they have retained that approach in their current architecture, so this explains why we don&rsquo;t have the kind of problems we get with Axum, which uses Tokio in a more standard way <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><h2 id=conclusion>Conclusion</h2><p>What at first seems to be a simple enough idea, can turn out to be, well, not so simple. This has been obvious to the people implementing async Rust for a while but it&rsquo;s less obvious if you&rsquo;re just writing code like me.</p><p>So far, I haven&rsquo;t had a use case where I don&rsquo;t want to require the <code>Send</code> bound at the trait level, but may want to require it for a specific implementation (which is what the <code>return_type_notation</code> achieves). It makes sense that there might be cases where this is desirable in a general purpose library.</p><p>Hopefully in a future Rust version it will be just as easy to turn the <code>Send</code> bound on or off for our trait methods as it is with <code>async-trait</code>. For now though, sticking with the <code>async-trait</code> macros is still the simplest option.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>A good example is the article <a href=https://smallcultfollowing.com/babysteps/blog/2023/02/01/async-trait-send-bounds-part-1-intro/>Async trait send bounds, part 1</a> by Niko Matsakis.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>This is also covered in <a href=https://smallcultfollowing.com/babysteps/blog/2023/02/13/return-type-notation-send-bounds-part-2/>Return type notation (send bounds, part 2)</a>. Note that using it currently breaks things like Rust <code>tracing</code> macros.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Fortunate for me at any rate. This <a href=https://github.com/rust-lang/rust/issues/114142>Github issue</a> describes the same problem and someone helpfully provided a workaround.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>See the discussion in this <a href=https://www.reddit.com/r/rust/comments/t1bim5/announcing_actix_web_v40/>actix web 4 release</a> announcement, for example (or read the code 🙂).&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></main></div><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "df78f068bb4f4ea0b8a0af4d60345dfd"}'></script></body></html>